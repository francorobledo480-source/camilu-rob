const express = require("express");
const http = require("http");
const { Server } = require("socket.io");

const app = express();
const server = http.createServer(app);
const io = new Server(server, { cors: { origin: "*" } });

const HTML = `
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cine Privado con mi Pareja</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body { margin: 0; background: #0a0a0a; color: white; font-family: sans-serif; display: flex; height: 100vh; overflow: hidden; }
  #video-area { flex-grow: 1; position: relative; display: flex; flex-direction: column; background: #000; }
  
  /* Video Principal */
  #main-display { width: 100%; flex-grow: 1; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
  #main-display video { width: 100%; height: 100%; object-fit: contain; }

  /* CÃ¡maras Flotantes */
  #cams { position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 15px; }
  .cam-container { width: 180px; height: 120px; border: 2px solid #ff0055; border-radius: 12px; overflow: hidden; background: #111; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
  .cam-container:hover { transform: scale(1.05); }
  .cam-container video { width: 100%; height: 100%; object-fit: cover; }
  .label { position: absolute; bottom: 5px; left: 10px; font-size: 12px; background: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 4px; }

  /* Chat Lateral */
  #chat-area { width: 300px; background: #111; display: flex; flex-direction: column; border-left: 1px solid #333; }
  #messages { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
  .msg { padding: 10px; border-radius: 10px; background: #222; max-width: 80%; font-size: 14px; line-height: 1.4; }
  .msg.me { align-self: flex-end; background: #ff0055; }
  #chat-input { padding: 15px; background: #1a1a1a; border: none; border-top: 1px solid #333; color: white; outline: none; }

  /* Controles Inferiores */
  footer { padding: 15px; background: #050505; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
  button { padding: 10px 15px; border-radius: 25px; border: none; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.2s; }
  .btn-invite { background: #0088ff; color: white; }
  .btn-share { background: #ff0055; color: white; }
  .btn-tool { background: #333; color: white; }
  button:hover { opacity: 0.8; transform: translateY(-2px); }
</style>
</head>
<body>

<div id="video-area">
  <div id="main-display">
    <video id="screen" playsinline autoplay></video>
  </div>

  <div id="cams">
    <div class="cam-container" onclick="swapVideo('local')">
      <video id="local" autoplay muted playsinline></video>
      <span class="label">TÃº</span>
    </div>
    <div class="cam-container" onclick="swapVideo('remote')">
      <video id="remote" autoplay playsinline></video>
      <span class="label">Pareja</span>
    </div>
  </div>

  <footer>
    <button class="btn-invite" onclick="copyLink()">ðŸ”— Enviar link a mi pareja</button>
    <button class="btn-share" onclick="share()">ðŸ“º Compartir PelÃ­cula</button>
    <button class="btn-tool" onclick="mic()">ðŸŽ¤ Micro</button>
    <button class="btn-tool" onclick="cam()">ðŸ“· CÃ¡mara</button>
  </footer>
</div>

<div id="chat-area">
  <div id="messages"></div>
  <input type="text" id="chat-input" placeholder="Escribe un mensaje..." onkeypress="sendMessage(event)">
</div>

<script>
const socket = io();
const room = location.hash.slice(1) || Math.random().toString(36).slice(2,8);
if(!location.hash) location.hash = room;

const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
let myStream;

socket.emit("join", room);

navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(s => {
  myStream = s;
  document.getElementById('local').srcObject = s;
  s.getTracks().forEach(t => pc.addTrack(t, s));
}).catch(e => alert("Por favor activa la cÃ¡mara para que tu pareja te vea."));

pc.ontrack = e => document.getElementById('remote').srcObject = e.streams[0];
pc.onicecandidate = e => e.candidate && socket.emit("signal", { room, data: e.candidate });

socket.on("signal", async d => {
  if (d.type === "offer") {
    await pc.setRemoteDescription(d);
    const a = await pc.createAnswer();
    await pc.setLocalDescription(a);
    socket.emit("signal", { room, data: a });
  } else if (d.type === "answer") {
    await pc.setRemoteDescription(d);
  } else {
    await pc.addIceCandidate(d);
  }
});

socket.on("user-joined", async () => {
  const o = await pc.createOffer();
  await pc.setLocalDescription(o);
  socket.emit("signal", { room, data: o });
  addMsg("â¤ï¸ Â¡Tu pareja se ha conectado!");
});

// FunciÃ³n para intercambiar video
function swapVideo(id) {
  const selectedStream = document.getElementById(id).srcObject;
  if(selectedStream) document.getElementById('screen').srcObject = selectedStream;
}

async function share() {
  try {
    const s = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
    document.getElementById('screen').srcObject = s;
    s.getTracks().forEach(t => pc.addTrack(t, s));
  } catch(e) {}
}

function copyLink() {
  navigator.clipboard.writeText(window.location.href);
  alert("Â¡Link copiado! PÃ©galo en el chat de tu pareja.");
}

function sendMessage(e) {
  if (e.key === "Enter" && e.target.value.trim()) {
    socket.emit("chat-message", { room, msg: e.target.value });
    addMsg("TÃº: " + e.target.value, "me");
    e.target.value = "";
  }
}

socket.on("chat-message", d => addMsg("Pareja: " + d.msg));

function addMsg(t, c) {
  const d = document.createElement("div");
  d.className = "msg " + (c || "");
  d.innerText = t;
  const m = document.getElementById("messages");
  m.appendChild(d);
  m.scrollTop = m.scrollHeight;
}

function mic() { myStream.getAudioTracks()[0].enabled = !myStream.getAudioTracks()[0].enabled; }
function cam() { myStream.getVideoTracks()[0].enabled = !myStream.getVideoTracks()[0].enabled; }
</script>
</body>
</html>
`;

app.get("/", (_, res) => res.send(HTML));

io.on("connection", socket => {
  socket.on("join", r => { socket.join(r); socket.to(r).emit("user-joined"); });
  socket.on("signal", d => socket.to(d.room).emit("signal", d.data));
  socket.on("chat-message", d => socket.to(d.room).emit("chat-message", d));
});

server.listen(process.env.PORT || 3000);
